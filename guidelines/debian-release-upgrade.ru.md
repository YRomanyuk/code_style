Debian Release Upgrade
======================

Этот гайдлайн описывает процесс обновления версии Debian в новом релизе и меры
поддержки старого релиза.

По этому гайдлайну производится переход на Debian Bullseye с Debian Stretch
между релизами wb-2204 и wb-2207.


Общие проблемы при обновлении
-----------------------------

Здесь описаны общие проблемы. Иногда миграция может получиться более
болезненной (например, такой была миграция с wheezy на stretch из-за отказа от
sysv в пользу systemd).

Основные проблемы:

  * нужно собирать пакеты новым компилятором, с новыми библиотеками
    (бинарными);
  * некоторые пакеты-зависимости могут быть удалены из репозиториев Debian или
    быть deprecated (актуальный пример - python2, к которому уже не собирают
    пакеты с библиотеками);
  * может понадобиться хитрая процедура обновления всей системы, если простого
    `apt update && apt dist-upgrade` не хватает;
  * может понадобиться бэкпортировать фиксы нашего ПО для версий пакетов из
    нашего предыдущего релиза (с предыдущим дистрибутивом Debian).

О том, как решать эти проблемы, расписано далее в этом гайдлайне.


Сборка пакетов под новый дистрибутив
------------------------------------

В Wiren Board сборка пакетов производится с помощью `devenv` (`wbdev`).

Начиная с релиза `stretch`, в `devenv` добавляется `schroot`-окружение, которое
позволяет собирать пакеты с помощью утилиты `sbuild`. Она производит сборку
пакета в своём `chroot` (отдельном для каждого поддерживаемого релиза Debian),
при этом автоматически устанавливает пакеты-зависимости (из списка
`Build-Depends`).

Для того, чтобы добавить поддержку нового дистрибутива в процедуру сборки
пакетов, нужно сделать следующее:

 1. Добавить в devenv новое schroot-окружение (описано в файле `devenv/build.sh`
   в репозитории [wirenboard](https://github.com/wirenboard/wirenboard/)).

 2. Добавить в `devenv/entrypoint.sh` новые таргеты. При обновлении до
    `bullseye` добавляем таргет `bullseye-armhf` (и для остальных архитектур
    или отдельных плат на той же архитектуре, если требуется). **Не меняем
    таргет для сборки по умолчанию!** (например, `current-armhf`). Это
    произойдёт позже в этой же инструкции.

 3. Замораживаем релиз `testing` для текущего дистрибутива Debian. Цель -
    оставить там пакеты, собранные для этого дистрибутива.

 4. Создаём для нового дистрибутива релиз `testing`. Его можно сразу назначит
    на `@unstable.latest`, если все пакеты готовы к работе с этим
    дистрибутивом. Как правило, так происходить не будет, потому можно создать
    его из замороженного списка, попутно добавляя туда исправленные пакеты (они
    могут быть в ветках, оттого не попадать в `latest`).

 5. В этот момент можно переназначить таргеты `current-*` в `devenv` на новый
    дистрибутив.

 6. Проверяем и вливаем все новые пакеты. В этот момент они могут собираться с
    таргетами `current-*`, старый дистрибутив не сломается.


Разрешение сломанных зависимостей
---------------------------------

Самый правильный способ разрешения сломанных зависимостей - переход на
обновлённые версии из нового дистрибутива. Это может потребовать изменения
кода, разумеется.

Такой способ безопасно работает после заморозки `testing` для старого
дистрибутива, т.к. новые пакеты туда автоматически уже не попадут.

Это самый предпочтительный сценарий.

В редких случаях может получиться так, что пакет-зависимость из нового
дистрибутива удалён, а поменять его мы ни на что не можем (очень старый софт,
или библиотека какая специфичная). В этом случае есть два пути решения:

 1. Осознанное решение выкинуть старый пакет (возможно, он уже просто никому не
    нужен). Так мы в своё время поступили с поддержкой модулей RFM69.

 2. Перенос пакетов-зависимостей. В этом случае нужно проверить, что пакет из
    репозитория прошлого дистрибутива нормально установится в новый (и
    зависимости разрешатся как надо), после чего пакет надо вручную добавить в
    пул и добавить в релизный список.


Хитрая процедура обновления
---------------------------

Специально для реализации хитрых процедур обновления существует пакет
`wb-update-manager` и соответствующая утилита `wb-release`.

В эту утилиту можно добавить код, который правильным образом произведёт
обновление системы.

Процедура обновления системы должна запускаться по флагу `--os-upgrade`. Она не
должна переключать текущий релиз у пользователя! Был `stable` - должен `stable`
и остаться.

Таким образом, путь внедрения хитрой процедуры обновления таков:

 1. Делаем ветку от того состояния `wb-release`, которое было доступно в
    `testing` старого дистрибутива на момент заморозки.

 2. Добавляем нужный код, убеждаемся, что он работает по флагу `--os-upgrade`.

 3. Создаём PR, название этой версии должно выглядеть так. Пусть старый релиз
    Debian имеет номер версии 9, версия утилиты в testing - `1.2.3`.
    Версия пакета получается такой: `1.2.3+deb9u1`. (конвенция взята из Debian
    policy). При внесении правок в процедуру обновления увеличиваем последнюю
    цифру (после `u`): `1.2.3+deb9u2`. **прим. webconn: я проверил, переход от
    `u9` к `u10` не ломает сравнение версий**.

    **FIXME:**: на момент публикации этого мануала `wbci-repo` никак не
    умеет отфильтровывать такие версии от попадания в `@unstable.latest`, это
    нужно починить.

    В рамках этого же PR надо добавить файл
    `/etc/update-motd.d/91wb-os-upgrade` (надо сделать так, чтобы он не был
    conffile) следующего содержания (поправить название версии):

```bash
#!/bin/bash -e

echo "New Debian release 11 (Bullseye) is available."
echo -ne "Run 'wb-release --os-upgrade' to upgrade to it.\n\n"
```

 6. Вливаем PR, добавляем новый wb-update-manager в релизный список.

После выполнения этапа 6, у нынешних пользователей `testing` появится
возможность обновиться до нового релиза Debian, а после выхода нового релиза
это автоматически будет доставлено до пользователей `stable`.

Автоматического обновления (которое потенциально может сломать пользователям
систему) произойти при этом не должно.


Бэкпортирование в старый дистрибутив
------------------------------------

Когда требуется перенести изменения в пакет в предыдущий релиз (на предыдущем
дистрибутиве Debian), работает стандартная процедура бэкпорта, с такими
поправками:

 - В Jenkinsfile в релизной ветке нужно прописать `defaultTarget`,
   соответствующий предыдущему релизу: вместо `wb6` или `current-armhf` вписать
   `stretch-armhf`.
 - Если переносится версия целиком (без добавления суффикса `-wbX`), то нужно к
   номеру версии добавить суффикс бэкпорта из Debian policy. Если предыдущая
   версия Debian имела номер 9, то суффикс должен быть `~bpo9+wb1`. Если
   понадобится исправление этого бэкпорта, увеличиваем последнюю цифру:
   `~bpo9+wb2`.
